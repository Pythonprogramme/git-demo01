{#    引入basic公共模板#}
{% extends 'basic/layout/basic_base_page.html' %}
{% block title %} 人员职位  {% endblock %}
{# 添加当前页面的css#}
{% block css %} {% endblock %}
{# 添加面包屑导航名称#}
{% block breadcrumb %}
    人员职位
 {% endblock %}
{# 添加当前页面的内容#}
{% block content %}
{#    基本信息#}
    <table class="layui-hide" id="tableArea"></table>
{#  表格中的按钮#}
    <script type="text/html" id="tableButton">
      <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit">
          <i class="layui-icon layui-icon   -edit"></i> 编辑
      </a>
      <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">
          <i class="layui-icon layui-icon-delete"></i> 删除
      </a>
    </script>

{#   弹出层内容#}
    <div id="layerContent" style="display: none; padding: 30px 40px 0 0">
        <form action="" class="layui-form" id="layerForm">
            <div class="layui-form-item">
                <label  class="layui-form-label" for="company">部门名称：</label>
                <div class="layui-input-block">
{#                    <input type="text" id="company" name="company" class="layui-input">#}
                    <select name="company" id="company" lay-search="">

                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label  class="layui-form-label" for="position">岗位名称：</label>
                <div class="layui-input-block">
                    <input type="text" id="position" name="position" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label  class="layui-form-label" for="position_name">员工姓名：</label>
                <div class="layui-input-block">
                    <input type="text" id="position_name" name="position_name" class="layui-input">
                </div>
            </div>
        </form>
    </div>
{% endblock %}
{# 添加当前页面的js#}
{% block js %}
    <script>
        // 入口函数
        $(function (){
            // 初始化表格
            initTable();
            // 响应按钮点击事件
            buttonClick()
        })
        // 初始化表格
        function initTable(queryStr=''){
            // 使用 table 插件
            layui.use('table',function (){
                // 实例化一个表格对象
                let table =layui.table;
                // 开始渲染表格
                table.render({
                    elem: '#tableArea'
                    // 请求数据后台接口
                    ,url: "{% url 'list_position' %}"
                    ,method: 'post'
                    ,where: {
                        inputStr: queryStr,
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    }
                    // 不同行背景不同显示
                    ,even: true // 表格斑马线效果
                    ,cols: [[
                        {type:'numbers', width:60, align: 'center', title: '编号', sort: true}
                        ,{field:'company__name', width:280,align: 'center', title: '部门名称',sort: true}
                        ,{field:'name', title: '职位名称', align: 'center',sort: true}
                        ,{field:'Personal_name', title: '员工姓名', align: 'center',sort: true}
                        ,{fixed: 'right', title: '操作',width:'20%', align:'center', toolbar: '#tableButton'}
                    ]]
                    // **是否显示顶部工具栏 （可直接导出）
                    ,toolbar: true
                    // 分页显示
                    ,page: true
                    /* 指定数据显示条数
                    * limit: 12
                    * limits: [12,15,20,30,50,75,100]
                    * */
                    // 加载数据异常时的提示
                    ,text: '加载数据出现异常，请联系管理员！'
                    // 表头样式显示
                    ,done: function (res, current, count){
                        $('thead tr').css({'background-color': '#009688','color': 'white'})
                    }
                })
            })
        }

        // 响应按钮点击事件
        function buttonClick() {
            // 查询按钮
            $('#btnQuery').on('click',function (){
                // 获取文本框的值
                let inputStr = $('#queryStr').val()
                initTable(inputStr)
            })
            // 全部按钮
            $('#btnAll').on('click',function (){
                // 页面重新加载
                location.reload();
            })
            // 添加按钮
            $('#btnAdd').on('click',function (){
                // 加载弹出层
                loadLayer();
            })


        }
        // 展示加载 弹出层
        function loadLayer(){
             layui.use(['layer','form'],function (){
            // 实例化一个弹出层对象
                let layer = layui.layer;
                let form = layui.form;
                // 展示
                layer.open({
                    type:  1,
                    title: '添加信息',
                    area: ['40%','40%'],
                    btn: ['确定','取消'],
                    content: $('#layerContent'),
                    // 设置弹出层的其他区域的颜色
                    shade: [0.6, '#000000'],
                    // 点击其他区域是否关闭弹窗层
                    shadeClose: false,
                    // 弹出框入场动画
                    anim: 5,
                    resize:  false,
                    // 响应的函数
                    success:  function (layero, index){
                        // 弹出层加载后自动执行的回调函数
                        // 自动获取所有部门信息
                        $.ajax({
                            url: '{% url 'list_company' %}',
                            method: 'get',
                            dataType: 'json',
                            success: function (res){
                                if (res.status){
                                    // 获取要放置的父容器
                                    let parentCentainer = $('#company')
                                    //使用 jquery 拼接成 option标签写入 select
                                    $('<option>').attr('value', '').text("直接选择或搜索选择").appendTo(parentCentainer)                               //使用 jquery 拼接成 option标签写入 select

                                    //遍历
                                    $.each(res.data, function (index, value){
                                        // 使用 jquery创建option标签
                                        $('<option>').attr('value', value.id).text(value.name).appendTo(parentCentainer);
                                    })
                                    // 重新渲染表单
                                    form.render();
                                } else {
                                    layer.msg('部门信息获取失败：',{icon:2, area: ['350px','150px'], time: -1, btn: ['关闭']})
                                }
                            }
                        })
                    },
                    // 确定按钮回调方法
                    yes: function (index,layero){
                        // 点击确定按钮的事件响应
                        // 添加的提交
                        $.ajax({
                            url: '{% url 'add_position' %}',
                            method: 'post',
                            data: $('#layerForm').serialize(),
                            dataType: 'json',
                            success: function (res){
                                if (res.status){
                                    // 重新加载页面
                                    location.reload();
                                } else {
                                    // 错误提示
                                    layer.msg(res.error,{icon:2, area: ['350px','150px'], time: -1, btn: ['关闭']})
                                }
                            }
                        })
                    },
                    btn1: function (index,layero){
                        // 点击第一个按钮的事件响应

                    },
                    btn2: function (index,layero){
                        // 点击第二个按钮的事件响应

                    },
                    cancel: function (index,layero){
                        // 点击右上角‘x’按钮的事件响应

                    },
                    end: function (index,layero){
                        // 弹出层销毁后自动执行的函数

                    }
                })
        })
        }
    </script>

{% endblock %}